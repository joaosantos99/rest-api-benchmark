name: Dependency Updates

on:
  schedule:
    # Run weekly on Mondays at 6 AM UTC
    - cron: '0 6 * * 1'
  workflow_dispatch:
    inputs:
      update_type:
        description: 'Type of updates to perform'
        required: true
        default: 'patch'
        type: choice
        options:
          - patch
          - minor
          - major
          - all
      services:
        description: 'Services to update (comma-separated or "all")'
        required: false
        default: 'all'
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  detect-updates:
    name: Detect Available Updates
    runs-on: ubuntu-latest
    outputs:
      node-updates: ${{ steps.node.outputs.updates }}
      rust-updates: ${{ steps.rust.outputs.updates }}
      go-updates: ${{ steps.go.outputs.updates }}
      java-updates: ${{ steps.java.outputs.updates }}
      python-updates: ${{ steps.python.outputs.updates }}
      base-image-updates: ${{ steps.base-images.outputs.updates }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check Node.js ecosystem updates
        id: node
        run: |
          UPDATES=false
          
          # Check Node.js services
          for service in node bun deno; do
            if [ -d "services/$service/src" ] && [ -f "services/$service/src/package.json" ]; then
              cd "services/$service/src"
              
              # Check for npm updates
              if command -v npm >/dev/null 2>&1; then
                npm outdated --json > outdated.json 2>/dev/null || true
                if [ -s outdated.json ] && [ "$(cat outdated.json)" != "{}" ]; then
                  echo "Found npm updates for $service"
                  UPDATES=true
                fi
              fi
              
              cd - > /dev/null
            fi
          done
          
          echo "updates=$UPDATES" >> $GITHUB_OUTPUT

      - name: Check Rust updates
        id: rust
        run: |
          UPDATES=false
          
          if [ -d "services/rust" ]; then
            cd services/rust
            
            # Check for cargo updates
            if command -v cargo >/dev/null 2>&1; then
              # Install cargo-outdated if not available
              cargo install cargo-outdated --quiet || true
              
              # Check for outdated dependencies
              if cargo outdated --exit-code 1 >/dev/null 2>&1; then
                echo "Found Rust updates"
                UPDATES=true
              fi
            fi
            
            cd - > /dev/null
          fi
          
          echo "updates=$UPDATES" >> $GITHUB_OUTPUT

      - name: Check Go updates
        id: go
        run: |
          UPDATES=false
          
          if [ -d "services/golang/src" ]; then
            cd services/golang/src
            
            # Check for Go module updates
            if command -v go >/dev/null 2>&1; then
              go list -u -m all > go_updates.txt 2>/dev/null || true
              if grep -q "=>" go_updates.txt; then
                echo "Found Go updates"
                UPDATES=true
              fi
            fi
            
            cd - > /dev/null
          fi
          
          echo "updates=$UPDATES" >> $GITHUB_OUTPUT

      - name: Check Java updates
        id: java
        run: |
          UPDATES=false
          
          for service in java17 java21 scala; do
            if [ -d "services/$service" ]; then
              case $service in
                scala)
                  if [ -f "services/$service/build.sbt" ]; then
                    echo "Found Scala project - updates available"
                    UPDATES=true
                  fi
                  ;;
                java*)
                  if [ -f "services/$service/pom.xml" ]; then
                    echo "Found Maven project - updates available"
                    UPDATES=true
                  fi
                  ;;
              esac
            fi
          done
          
          echo "updates=$UPDATES" >> $GITHUB_OUTPUT

      - name: Check Python updates
        id: python
        run: |
          UPDATES=false
          
          if [ -d "services/python/src" ]; then
            cd services/python/src
            
            # Check for pip updates (basic check)
            if [ -f "requirements.txt" ] && [ -s "requirements.txt" ]; then
              # For now, just mark as having potential updates
              UPDATES=true
            fi
            
            cd - > /dev/null
          fi
          
          echo "updates=$UPDATES" >> $GITHUB_OUTPUT

      - name: Check base image updates
        id: base-images
        run: |
          UPDATES=false
          
          # Check for newer base images by pulling latest and comparing
          IMAGES=(
            "node:20-alpine"
            "rust:1.80-bookworm"
            "golang:1.25.1-bookworm"
            "python:3.12-alpine"
            "ubuntu:24.04"
            "eclipse-temurin:17-jdk"
            "eclipse-temurin:21-jdk"
          )
          
          for image in "${IMAGES[@]}"; do
            echo "Checking base image: $image"
            # For this example, we'll assume updates are available
            # In practice, you'd compare digests or use tools like renovate
            UPDATES=true
            break
          done
          
          echo "updates=$UPDATES" >> $GITHUB_OUTPUT

  update-node-dependencies:
    name: Update Node.js Dependencies
    runs-on: ubuntu-latest
    needs: detect-updates
    if: needs.detect-updates.outputs.node-updates == 'true'
    strategy:
      matrix:
        service: [node, bun, deno]
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Update dependencies
        run: |
          if [ ! -d "services/${{ matrix.service }}/src" ] || [ ! -f "services/${{ matrix.service }}/src/package.json" ]; then
            echo "No package.json found for ${{ matrix.service }}"
            exit 0
          fi
          
          cd "services/${{ matrix.service }}/src"
          
          # Backup original package.json
          cp package.json package.json.backup
          
          # Update dependencies based on update type
          UPDATE_TYPE="${{ github.event.inputs.update_type || 'patch' }}"
          
          case "$UPDATE_TYPE" in
            "patch")
              npm update
              ;;
            "minor")
              npx npm-check-updates -u -t minor
              npm install
              ;;
            "major")
              npx npm-check-updates -u
              npm install
              ;;
            "all")
              npx npm-check-updates -u
              npm install
              ;;
          esac
          
          # Test that the service still builds
          cd ../../..
          if ! docker build -t "test-${{ matrix.service }}" "./services/${{ matrix.service }}"; then
            echo "Build failed after dependency update, reverting..."
            cd "services/${{ matrix.service }}/src"
            cp package.json.backup package.json
            npm install
            exit 1
          fi
          
          # Clean up test image
          docker rmi "test-${{ matrix.service }}" || true

      - name: Test updated service
        run: |
          if [ ! -d "services/${{ matrix.service }}/src" ]; then
            exit 0
          fi
          
          # Build and test the service
          docker build -t "bench/${{ matrix.service }}" "./services/${{ matrix.service }}"
          
          # Start service and test endpoints
          docker run -d --name "test-${{ matrix.service }}" -p 18080:8080 "bench/${{ matrix.service }}"
          sleep 5
          
          # Test basic endpoints
          if ! curl -f http://localhost:18080/api/hello-world; then
            echo "Service test failed after dependency update"
            docker logs "test-${{ matrix.service }}"
            docker stop "test-${{ matrix.service }}"
            docker rm "test-${{ matrix.service }}"
            exit 1
          fi
          
          docker stop "test-${{ matrix.service }}"
          docker rm "test-${{ matrix.service }}"

      - name: Commit changes
        run: |
          if [ ! -d "services/${{ matrix.service }}/src" ]; then
            exit 0
          fi
          
          cd "services/${{ matrix.service }}/src"
          
          if git diff --quiet package.json; then
            echo "No changes to commit"
            exit 0
          fi
          
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add package.json package-lock.json 2>/dev/null || git add package.json
          git commit -m "deps(${{ matrix.service }}): update Node.js dependencies (${{ github.event.inputs.update_type || 'patch' }} updates)"

      - name: Upload changes
        uses: actions/upload-artifact@v4
        with:
          name: node-updates-${{ matrix.service }}
          path: services/${{ matrix.service }}/src/package*.json
          retention-days: 7

  update-rust-dependencies:
    name: Update Rust Dependencies
    runs-on: ubuntu-latest
    needs: detect-updates
    if: needs.detect-updates.outputs.rust-updates == 'true'
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          toolchain: stable
          override: true

      - name: Install cargo-edit
        run: cargo install cargo-edit

      - name: Update Rust dependencies
        run: |
          cd services/rust
          
          # Backup original Cargo.toml
          cp Cargo.toml Cargo.toml.backup
          
          # Update dependencies based on type
          UPDATE_TYPE="${{ github.event.inputs.update_type || 'patch' }}"
          
          case "$UPDATE_TYPE" in
            "patch")
              cargo update
              ;;
            "minor"|"major"|"all")
              # For Rust, we'll be conservative and only do compatible updates
              cargo upgrade --compatible
              ;;
          esac

      - name: Test Rust service
        run: |
          cd services/rust
          
          # Test that it builds
          if ! cargo build --release; then
            echo "Build failed after dependency update, reverting..."
            cp Cargo.toml.backup Cargo.toml
            cargo build --release
            exit 1
          fi
          
          # Test with Docker
          cd ../..
          if ! docker build -t bench/rust ./services/rust; then
            echo "Docker build failed after dependency update"
            exit 1
          fi

      - name: Commit Rust changes
        run: |
          cd services/rust
          
          if git diff --quiet Cargo.toml Cargo.lock; then
            echo "No changes to commit"
            exit 0
          fi
          
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add Cargo.toml Cargo.lock
          git commit -m "deps(rust): update Rust dependencies (${{ github.event.inputs.update_type || 'patch' }} updates)"

  update-base-images:
    name: Update Base Images
    runs-on: ubuntu-latest
    needs: detect-updates
    if: needs.detect-updates.outputs.base-image-updates == 'true'
    strategy:
      matrix:
        service:
          - node
          - bun
          - deno
          - golang
          - rust
          - python
          - java17
          - java21
          - scala
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Update base images
        run: |
          DOCKERFILE="services/${{ matrix.service }}/Dockerfile"
          
          if [ ! -f "$DOCKERFILE" ]; then
            echo "Dockerfile not found for ${{ matrix.service }}"
            exit 0
          fi
          
          # Update base images to latest patch versions
          # This is a simplified example - in practice you'd want more sophisticated version parsing
          case "${{ matrix.service }}" in
            "node")
              sed -i 's/node:[0-9]*\.[0-9]*-alpine/node:20-alpine/g' "$DOCKERFILE"
              ;;
            "rust")
              sed -i 's/rust:[0-9]*\.[0-9]*-bookworm/rust:1.80-bookworm/g' "$DOCKERFILE"
              ;;
            "golang")
              sed -i 's/golang:[0-9]*\.[0-9]*\.[0-9]*-bookworm/golang:1.25.1-bookworm/g' "$DOCKERFILE"
              ;;
            "python")
              sed -i 's/python:[0-9]*\.[0-9]*-alpine/python:3.12-alpine/g' "$DOCKERFILE"
              ;;
            "java17")
              sed -i 's/eclipse-temurin:17-jdk/eclipse-temurin:17-jdk/g' "$DOCKERFILE"
              ;;
            "java21")
              sed -i 's/eclipse-temurin:21-jdk/eclipse-temurin:21-jdk/g' "$DOCKERFILE"
              ;;
          esac

      - name: Test updated image
        run: |
          DOCKERFILE="services/${{ matrix.service }}/Dockerfile"
          
          if [ ! -f "$DOCKERFILE" ]; then
            exit 0
          fi
          
          # Test that the service still builds with updated base images
          if ! docker build -t "test-${{ matrix.service }}" "./services/${{ matrix.service }}"; then
            echo "Build failed with updated base image for ${{ matrix.service }}"
            git checkout -- "$DOCKERFILE"
            exit 1
          fi
          
          # Basic functionality test
          docker run -d --name "test-${{ matrix.service }}" -p 18080:8080 "test-${{ matrix.service }}"
          sleep 10
          
          if ! curl -f http://localhost:18080/api/hello-world --max-time 10; then
            echo "Service test failed with updated base image"
            docker logs "test-${{ matrix.service }}"
            docker stop "test-${{ matrix.service }}"
            docker rm "test-${{ matrix.service }}"
            git checkout -- "$DOCKERFILE"
            exit 1
          fi
          
          docker stop "test-${{ matrix.service }}"
          docker rm "test-${{ matrix.service }}"
          docker rmi "test-${{ matrix.service }}"

      - name: Commit base image updates
        run: |
          DOCKERFILE="services/${{ matrix.service }}/Dockerfile"
          
          if [ ! -f "$DOCKERFILE" ]; then
            exit 0
          fi
          
          if git diff --quiet "$DOCKERFILE"; then
            echo "No changes to commit for ${{ matrix.service }}"
            exit 0
          fi
          
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add "$DOCKERFILE"
          git commit -m "deps(${{ matrix.service }}): update base images"

  create-update-pr:
    name: Create Update Pull Request
    runs-on: ubuntu-latest
    needs: [update-node-dependencies, update-rust-dependencies, update-base-images]
    if: always() && (needs.update-node-dependencies.result == 'success' || needs.update-rust-dependencies.result == 'success' || needs.update-base-images.result == 'success')
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check for changes
        id: changes
        run: |
          # Pull any commits made by the update jobs
          git pull origin ${{ github.ref_name }} || true
          
          if git diff --quiet HEAD~5..HEAD; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "No dependency updates to create PR for"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "Found dependency updates"
          fi

      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'deps: automated dependency updates'
          title: 'Automated Dependency Updates (${{ github.event.inputs.update_type || 'patch' }})'
          body: |
            ## ğŸ¤– Automated Dependency Updates
            
            This PR contains automated dependency updates for the REST API Benchmarks project.
            
            ### Update Type
            
            **${{ github.event.inputs.update_type || 'patch' }}** updates
            
            ### Changes Made
            
            - âœ… Node.js ecosystem updates: ${{ needs.update-node-dependencies.result }}
            - âœ… Rust dependency updates: ${{ needs.update-rust-dependencies.result }}
            - âœ… Base image updates: ${{ needs.update-base-images.result }}
            
            ### Testing
            
            All services have been tested to ensure they build and run correctly with the updated dependencies.
            
            ### Review Checklist
            
            - [ ] All CI checks pass
            - [ ] Performance benchmarks show no regressions
            - [ ] Security scans pass
            - [ ] Manual testing of critical endpoints
            
            ### Notes
            
            - This PR was automatically generated
            - Each service was tested individually before inclusion
            - Failed updates were automatically reverted
            
            ---
            
            ğŸ”„ **Auto-merge**: This PR will be automatically merged if all checks pass and there are no breaking changes.
          branch: deps/automated-updates-${{ github.run_number }}
          delete-branch: true
          assignees: ${{ github.actor }}
          reviewers: ${{ github.actor }}
          labels: |
            dependencies
            automated
            
      - name: Enable auto-merge
        if: steps.changes.outputs.has_changes == 'true' && github.event.inputs.update_type != 'major'
        run: |
          # For non-major updates, enable auto-merge
          echo "Auto-merge would be enabled for patch/minor updates"
          # In practice: gh pr merge --auto --merge

  security-audit:
    name: Security Audit After Updates
    runs-on: ubuntu-latest
    needs: create-update-pr
    if: needs.create-update-pr.result == 'success'
    steps:
      - name: Checkout updated code
        uses: actions/checkout@v4
        with:
          ref: deps/automated-updates-${{ github.run_number }}

      - name: Run security audit
        run: |
          # Node.js security audit
          for service in node bun deno; do
            if [ -d "services/$service/src" ] && [ -f "services/$service/src/package.json" ]; then
              cd "services/$service/src"
              npm audit --audit-level=moderate || echo "Security issues found in $service"
              cd - > /dev/null
            fi
          done
          
          # Rust security audit
          if [ -d "services/rust" ]; then
            cd services/rust
            cargo audit || echo "Security issues found in Rust dependencies"
            cd - > /dev/null
          fi

      - name: Update PR with security status
        uses: actions/github-script@v7
        with:
          script: |
            // Add security audit results to PR
            const { data: pulls } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:deps/automated-updates-${{ github.run_number }}`,
              state: 'open'
            });
            
            if (pulls.length > 0) {
              const pr = pulls[0];
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: 'ğŸ”’ Security audit completed. Check workflow logs for details.'
              });
            }

  notify-completion:
    name: Notify Update Completion
    runs-on: ubuntu-latest
    needs: [detect-updates, create-update-pr, security-audit]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "ğŸ”„ Dependency Update Summary"
          echo "=========================="
          echo "Detection: ${{ needs.detect-updates.result }}"
          echo "PR Creation: ${{ needs.create-update-pr.result }}"
          echo "Security Audit: ${{ needs.security-audit.result }}"
          
          if [ "${{ needs.create-update-pr.result }}" == "success" ]; then
            echo "âœ… Dependency update PR created successfully"
          else
            echo "â„¹ï¸ No dependency updates required or updates failed"
          fi
